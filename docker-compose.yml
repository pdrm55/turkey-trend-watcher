version: '3.8'

services:
  # --- [Infrastructure] ---
  postgres:
    image: postgres:15-alpine
    container_name: ttw_postgres
    restart: always
    environment:
      POSTGRES_USER: ${POSTGRES_USER:-admin}
      POSTGRES_PASSWORD: ${POSTGRES_PASSWORD:-secretpassword}
      POSTGRES_DB: ${POSTGRES_DB:-trend_watcher_db}
    ports: ["5433:5432"]
    volumes: ["postgres_data:/var/lib/postgresql/data"]
    networks: ["ttw_network"]

  redis:
    image: redis:alpine
    container_name: ttw_redis
    restart: always
    networks: ["ttw_network"]

  chromadb:
    image: chromadb/chroma:latest
    container_name: ttw_chroma
    volumes: ["chroma_data:/chroma/data"]
    networks: ["ttw_network"]
    restart: always

  ollama:
    image: ollama/ollama:latest
    container_name: ttw_ollama
    volumes: ["ollama_data:/root/.ollama"]
    networks: ["ttw_network"]
    restart: always

  # --- [Initialization Task] ---
  db_init:
    build: .
    container_name: ttw_init
    depends_on: ["postgres", "ollama"]
    volumes: [".:/app"]
    env_file: [".env"]
    networks: ["ttw_network"]
    entrypoint: ["/bin/bash", "-c"]
    command: 
      - |
        echo "ğŸ“‚ Starting Database & AI Model Initialization..."
        python3 -c "from app.database.models import init_db; init_db()"
        echo "â¬‡ï¸ Pulling AI Model (Qwen)..."
        curl -X POST http://ttw_ollama:11434/api/pull -d '{"name": "qwen2.5:1.5b"}'
        echo "âœ… Initialization Complete."

  # --- [Web Services - Ø§Ø±ØªÙ‚Ø§ ÛŒØ§ÙØªÙ‡ Ø¨Ù‡ Gunicorn] ---
  api_server:
    build: .
    container_name: ttw_api
    depends_on:
      db_init: { condition: service_completed_successfully }
    volumes: [".:/app"]
    env_file: [".env"]
    ports: ["5000:5000"]
    networks: ["ttw_network"]
    entrypoint: ["/bin/bash", "/app/scripts/entrypoint.sh"]
    # ØªÙ†Ø¸ÛŒÙ… Ø´Ø¯Ù‡ Ø¨Ø±Ø§ÛŒ Ø³Ø®Øªâ€ŒØ§ÙØ²Ø§Ø± Û¶ Ù‡Ø³ØªÙ‡â€ŒØ§ÛŒ: Û¶ ÙˆØ±Ú©Ø± Ù…Ø³ØªÙ‚Ù„ Ø¨Ø§ ØªØ§ÛŒÙ…â€ŒØ§ÙˆØª Ù…Ù†Ø§Ø³Ø¨ Ø¨Ø±Ø§ÛŒ Ù¾Ø±Ø¯Ø§Ø²Ø´â€ŒÙ‡Ø§ÛŒ Ø³Ù†Ú¯ÛŒÙ†
    command: gunicorn --workers 6 --bind 0.0.0.0:5000 --timeout 120 --access-logfile - web_server:app

  dashboard:
    build: .
    container_name: ttw_dashboard
    depends_on: ["api_server"]
    volumes: [".:/app"]
    env_file: [".env"]
    ports: ["8501:8501"]
    networks: ["ttw_network"]
    entrypoint: ["/bin/bash", "/app/scripts/entrypoint.sh"]
    command: streamlit run app/workers/dashboard.py --server.port 8501 --server.address 0.0.0.0

  # --- [Isolated Workers] ---
  telegram_worker:
    build: .
    container_name: ttw_telegram
    profiles: ["workers"]
    depends_on:
      db_init: { condition: service_completed_successfully }
    volumes: [".:/app"]
    env_file: [".env"]
    networks: ["ttw_network"]
    entrypoint: ["/bin/bash", "/app/scripts/entrypoint.sh"]
    command: python3 app/collectors/telegram_bot.py

  rss_worker:
    build: .
    container_name: ttw_rss
    profiles: ["workers"]
    depends_on:
      db_init: { condition: service_completed_successfully }
    volumes: [".:/app"]
    env_file: [".env"]
    networks: ["ttw_network"]
    entrypoint: ["/bin/bash", "/app/scripts/entrypoint.sh"]
    command: python3 app/collectors/rss_fetcher.py

  summarizer:
    build: .
    container_name: ttw_summarizer
    profiles: ["workers"]
    depends_on: ["api_server"]
    volumes: [".:/app"]
    env_file: [".env"]
    networks: ["ttw_network"]
    entrypoint: ["/bin/bash", "/app/scripts/entrypoint.sh"]
    command: python3 app/workers/summarizer.py

  gravity_worker:
    build: .
    container_name: ttw_gravity
    profiles: ["workers"]
    depends_on: ["api_server"]
    volumes: [".:/app"]
    env_file: [".env"]
    networks: ["ttw_network"]
    entrypoint: ["/bin/bash", "/app/scripts/entrypoint.sh"]
    command: python3 app/workers/gravity_worker.py

  telegram_bot_worker:
    build: .
    container_name: ttw_interactive_bot
    profiles: ["workers"]
    depends_on:
      - postgres
    volumes:
      - .:/app
    env_file:
      - .env
    networks:
      - ttw_network
    restart: always
    command: python3 app/workers/telegram_bot_worker.py

volumes:
  postgres_data:
  ollama_data:
  chroma_data:

networks:
  ttw_network:
    driver: bridge