<!DOCTYPE html>
<html lang="tr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    
    <!-- Dynamic SEO Meta Tags -->
    <title>{{ trend.title }} | TrendiaTR Haber Analizi</title>
    <meta name="description" content="{{ trend.summary[:160] | replace('"', '\\"') if trend.summary else 'TrendiaTR ile gerÃ§ek zamanlÄ± yapØ§ÛŒ Ø²Ú©Ø§ haber analizi.' }}">
    <link rel="canonical" href="https://trendiatr.com/trend/{{ trend.slug }}">
    
    <!-- Open Graph -->
    <meta property="og:type" content="article">
    <meta property="og:title" content="{{ trend.title }}">
    <meta property="og:description" content="{{ trend.summary[:200] | replace('"', '\\"') if trend.summary else '' }}">
    <meta property="og:url" content="https://trendiatr.com/trend/{{ trend.slug }}">
    <meta property="og:site_name" content="TrendiaTR">
    <meta property="og:image" content="https://trendiatr.com/static/og-image.png">

    <!-- Twitter -->
    <meta name="twitter:card" content="summary_large_image">
    <meta name="twitter:title" content="{{ trend.title }}">
    <meta name="twitter:description" content="{{ trend.summary[:200] | replace('"', '\\"') if trend.summary else '' }}">
    <meta name="twitter:image" content="https://trendiatr.com/static/og-image.png">

    <link rel="icon" type="image/svg+xml" href="data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'%3E%3Crect width='100' height='100' rx='20' fill='%23ef4444'/%3E%3Ctext x='50%25' y='53%25' dominant-baseline='middle' text-anchor='middle' font-family='Inter, sans-serif' font-weight='800' font-size='60' fill='white'%3ETT%3C/text%3E%3C/svg%3E">

    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;800&display=swap" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    
    <!-- JSON-LD Structured Data for News Article -->
    <script type="application/ld+json">
    {
      "@context": "https://schema.org",
      "@type": "NewsArticle",
      "mainEntityOfPage": { "@type": "WebPage", "@id": "https://trendiatr.com/trend/{{ trend.slug }}" },
      "headline": "{{ trend.title | replace('"', '\\"') }}",
      "description": "{{ trend.summary[:200] | replace('"', '\\"') if trend.summary else '' }}",
      "articleBody": "{{ trend.summary | replace('"', '\\"') if trend.summary else '' }}",
      "image": ["https://trendiatr.com/static/og-image.png"],
      "datePublished": "{{ trend.first_seen.isoformat() if trend.first_seen else '' }}",
      "dateModified": "{{ trend.last_updated.isoformat() if trend.last_updated else '' }}",
      "author": { "@type": "Organization", "name": "TrendiaTR AI" },
      "publisher": { 
        "@type": "Organization", 
        "name": "TrendiaTR", 
        "logo": { "@type": "ImageObject", "url": "https://trendiatr.com/static/logo.png" } 
      }
    }
    </script>

    <style>
        body { font-family: 'Inter', sans-serif; background-color: #f8fafc; color: #1e293b; }
        .custom-scroll::-webkit-scrollbar { width: 8px; }
        .custom-scroll::-webkit-scrollbar-thumb { background: #cbd5e1; border-radius: 4px; }
        .trajectory-up { color: #10b981; }
        .trajectory-down { color: #f43f5e; }
    </style>
</head>
<body class="p-4 md:p-8 pb-20">

    <nav class="max-w-4xl mx-auto mb-8 flex items-center justify-between">
        <a href="/" class="text-blue-600 font-bold flex items-center gap-2 hover:underline">
            <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10 19l-7-7m0 0l7-7m-7 7h18"></path></svg>
            Ana Sayfa
        </a>
        <div class="flex items-center gap-2 text-xs font-bold text-slate-400 uppercase tracking-widest">
            <span>Trendia</span><span class="text-red-600">TR</span> AI ANALÄ°ZÄ°
        </div>
    </nav>

    <article class="max-w-4xl mx-auto bg-white rounded-3xl shadow-xl overflow-hidden border border-slate-100">
        <header class="p-8 md:p-12 border-b border-slate-50 bg-slate-50/50">
            <div class="flex justify-between items-start mb-6">
                <div class="flex items-center gap-3">
                    <span class="bg-blue-600 text-white text-[10px] font-black px-3 py-1 rounded-full uppercase tracking-widest">
                        {{ trend.category }}
                    </span>
                    <span class="text-slate-400 text-xs font-medium">
                        {{ trend.last_updated.strftime('%d %B %Y, %H:%M') if trend.last_updated else '' }}
                    </span>
                </div>
                
                <!-- TPS Metric & Trajectory Display -->
                <div class="text-right">
                    <div class="text-[10px] font-black text-slate-400 uppercase tracking-widest flex items-center justify-end gap-1">
                        Trend Durumu 
                        {% if trend.trajectory == 'up' %}
                            <span class="trajectory-up">â–²</span>
                        {% elif trend.trajectory == 'down' %}
                            <span class="trajectory-down">â–¼</span>
                        {% endif %}
                    </div>
                    <div class="text-3xl font-black text-red-600 leading-none mt-1">
                        {{ trend.final_tps | round(1) }} <span class="text-xs">TPS</span>
                    </div>
                </div>
            </div>

            <h1 class="text-3xl md:text-5xl font-black text-slate-900 leading-tight mb-8">
                {{ trend.title }}
            </h1>

            <div class="flex flex-wrap items-center gap-4">
                <!-- Dynamic Signal Strength with Progress Bar -->
                {% set tps_val = trend.tps_signal %}
                {% if tps_val < 20 %}
                    {% set sig_color = "text-slate-500" %}
                    {% set bar_color = "bg-slate-500" %}
                    {% set sig_label = "DÃ¼ÅŸÃ¼k" %}
                {% elif tps_val < 40 %}
                    {% set sig_color = "text-orange-500" %}
                    {% set bar_color = "bg-orange-500" %}
                    {% set sig_label = "Orta" %}
                {% else %}
                    {% set sig_color = "text-red-600" %}
                    {% set bar_color = "bg-red-600" %}
                    {% set sig_label = "YÃ¼ksek" %}
                {% endif %}

                <div class="bg-white px-4 py-3 rounded-xl border border-slate-100 shadow-sm flex flex-col justify-center min-w-[140px]">
                    <span class="text-[9px] font-black text-slate-400 block uppercase tracking-widest mb-1">Sinyal GÃ¼cÃ¼</span>
                    <div class="flex items-baseline gap-2 mb-1">
                        <span class="text-xl font-black {{ sig_color }}">{{ tps_val | round(1) }}</span>
                        <span class="text-[10px] font-bold {{ sig_color }} uppercase">{{ sig_label }}</span>
                    </div>
                    <div class="w-full bg-slate-100 rounded-full h-1.5 overflow-hidden">
                        <div class="h-full {{ bar_color }}" style="width: {{ (tps_val / 100 * 100) | min(100) }}%"></div>
                    </div>
                </div>

                <div class="bg-white px-4 py-3 rounded-xl border border-slate-100 shadow-sm h-[76px] flex flex-col justify-center">
                    <span class="text-[9px] font-black text-slate-400 block uppercase tracking-widest mb-1">GÃ¼ven Endeksi</span>
                    <span class="text-xl font-black text-slate-700">%{{ (trend.tps_confidence * 100) | int }}</span>
                </div>

                <div class="bg-white px-4 py-3 rounded-xl border border-slate-100 shadow-sm h-[76px] flex flex-col justify-center">
                    <span class="text-[9px] font-black text-slate-400 block uppercase tracking-widest mb-1">Kaynak SayÄ±sÄ±</span>
                    <span class="text-xl font-black text-slate-700">{{ trend.message_count }}</span>
                </div>

                <!-- Sparkline Chart Container -->
                <div class="bg-white px-3 py-2 rounded-xl border border-slate-100 shadow-sm overflow-hidden relative flex flex-col justify-center" style="width: 220px; height: 76px;">
                    <h3 class="text-[9px] font-black text-slate-400 uppercase mb-1">Trend YÃ¶rÃ¼ngesi (Son 24s)</h3>
                    <div class="flex-1 relative w-full">
                        <canvas id="tpsChart"></canvas>
                    </div>
                </div>
            </div>
        </header>

        <div class="p-8 md:p-12">
            <!-- AI Summary Content Section -->
            <div class="mb-12">
                <h2 class="text-[10px] font-black text-blue-600 uppercase tracking-[0.2em] mb-4">Yapay Zeka Ã–zeti</h2>
                <div class="prose prose-slate max-w-none">
                    <p class="text-lg text-slate-700 leading-relaxed font-medium">
                        {{ trend.summary }}
                    </p>
                </div>
            </div>

            <!-- News Signal History -->
            <div class="mb-16">
                <h2 class="text-[10px] font-black text-slate-400 uppercase tracking-[0.2em] mb-6 flex items-center gap-4">
                    Gelen Sinyaller
                    <div class="h-px bg-slate-100 flex-1"></div>
                </h2>
                <div class="space-y-4">
                    {% for news in news_list %}
                    <div class="bg-slate-50 p-6 rounded-2xl border border-slate-100 transition-all hover:border-blue-200">
                        <div class="flex justify-between items-center mb-3">
                            <span class="text-xs font-black text-blue-600 uppercase tracking-wider">{{ news.source }}</span>
                            {% if news.link %}
                            <a href="{{ news.link }}" target="_blank" class="text-[10px] font-bold text-slate-400 hover:text-blue-600 transition-colors">KAYNAÄžA GÄ°T â†—</a>
                            {% endif %}
                        </div>
                        <p class="text-sm text-slate-600 leading-relaxed">{{ news.content }}</p>
                        <div class="mt-2 text-[10px] text-slate-400 font-medium">
                            {{ news.time.strftime('%H:%M') if news.time else '' }}
                        </div>
                    </div>
                    {% endfor %}
                </div>
            </div>

            <!-- Related Trends Recommendation Section -->
            {% if related_trends %}
            <div class="pt-12 border-t border-slate-100">
                <h3 class="text-xl font-black text-slate-900 mb-8 flex items-center gap-3">
                    <span class="text-2xl">ðŸ”—</span> Benzer GeliÅŸmeler
                </h3>
                <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                    {% for r_trend in related_trends %}
                    <a href="/trend/{{ r_trend.slug if r_trend.slug else r_trend.cluster_id }}" 
                       class="bg-white p-5 rounded-2xl border border-slate-100 hover:border-blue-300 hover:shadow-lg transition-all group flex flex-col justify-between">
                        <div>
                            <span class="text-[10px] font-bold text-blue-600 uppercase tracking-widest mb-2 block">{{ r_trend.category }}</span>
                            <h4 class="text-sm font-bold text-slate-800 group-hover:text-blue-600 line-clamp-2 leading-snug">
                                {{ r_trend.title }}
                            </h4>
                        </div>
                        <div class="mt-4 flex items-center justify-between">
                            <span class="text-[10px] text-slate-400 font-medium">{{ r_trend.last_updated.strftime('%d.%m.%Y') if r_trend.last_updated else '' }}</span>
                            <span class="text-[10px] font-bold text-blue-500 flex items-center gap-1 group-hover:translate-x-1 transition-transform">
                                OKU â†’
                            </span>
                        </div>
                    </a>
                    {% endfor %}
                </div>
            </div>
            {% endif %}
        </div>
    </article>

    <footer class="max-w-4xl mx-auto mt-12 text-center">
        <p class="text-slate-400 text-sm italic">&copy; 2026 TrendiaTR - TÃ¼m analizler yapØ§ÛŒ Ø²Ú©Ø§ tarafÄ±ndan gerÃ§ek zamanlÄ± oluÅŸturulmaktadÄ±r.</p>
    </footer>

    <script>
        document.addEventListener('DOMContentLoaded', async function() {
            const ctx = document.getElementById('tpsChart').getContext('2d');
            const trendId = "{{ trend.id }}";

            try {
                const response = await fetch(`/api/trends/${trendId}/history`);
                const historyData = await response.json();
                
                new Chart(ctx, {
                    type: 'line',
                    data: {
                        labels: historyData.labels,
                        datasets: [{
                            data: historyData.data,
                            borderColor: '#ef4444',
                            borderWidth: 2,
                            backgroundColor: (context) => {
                                const ctx = context.chart.ctx;
                                const gradient = ctx.createLinearGradient(0, 0, 0, 60);
                                gradient.addColorStop(0, 'rgba(239, 68, 68, 0.1)');
                                gradient.addColorStop(1, 'rgba(239, 68, 68, 0.0)');
                                return gradient;
                            },
                            fill: true,
                            pointRadius: 0,
                            tension: 0.4
                        }]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        plugins: {
                            legend: { display: false },
                            tooltip: { 
                                enabled: true,
                                mode: 'index',
                                intersect: false,
                                backgroundColor: 'rgba(255, 255, 255, 0.95)',
                                titleColor: '#64748b',
                                bodyColor: '#0f172a',
                                borderColor: '#e2e8f0',
                                borderWidth: 1,
                                padding: 6,
                                displayColors: false,
                                titleFont: { size: 10 },
                                bodyFont: { size: 12, weight: 'bold' },
                                callbacks: {
                                    label: function(context) {
                                        return context.parsed.y + ' Sinyal';
                                    }
                                }
                            }
                        },
                        scales: {
                            x: { display: false },
                            y: { 
                                display: true, 
                                beginAtZero: true,
                                grid: { color: '#f1f5f9', drawBorder: false },
                                ticks: { display: false }
                            }
                        },
                        interaction: {
                            mode: 'nearest',
                            intersect: false
                        }
                    }
                });
            } catch (e) {
                console.error("Chart loading failed:", e);
            }
        });
    </script>
</body>
</html>